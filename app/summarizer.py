# summarizer.py
import os
import datetime
import logging
from typing import Optional, Tuple
from openai import OpenAI

# -----------------------------
# ë¡œê±° ì„¤ì •
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)
logger = logging.getLogger(__name__)

# -----------------------------
# OpenAI API í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
# -----------------------------
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# -----------------------------
# ì–¸ì–´ë³„ í”„ë¡¬í”„íŠ¸ ë° ë©”íƒ€ë°ì´í„° ì„¤ì •
# -----------------------------
LANGUAGES = {
    "ko": {
        "name": "ê¸ì •ì  ê´€ì ",
        "system_prompt": "ë‹¹ì‹ ì€ ê¸ì •ì  ê´€ì ì˜ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œ, ì˜ˆìƒë³´ë‹¤ ì„±ì¥ì„¸! í†µê³„ë¡œ ë³¸ í¬ë§ ì‹ í˜¸'ì™€ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ë¶í•œì˜ ìµœê·¼ ìƒì‚°ëŸ‰ ì¦ê°€ë‚˜ íŠ¹ì • ì‚°ì—…ì˜ ë°œì „ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•˜ê³ , ë¶í•œ ê²½ì œì˜ ê¸ì •ì ì¸ ì¸¡ë©´ì„ ë¶€ê°í•˜ì—¬ í¬ë§ì ì¸ í†¤ìœ¼ë¡œ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "en": {
        "name": "ë¶€ì •ì  ê´€ì ",
        "system_prompt": "ë‹¹ì‹ ì€ ë¶€ì •ì  ê´€ì ì˜ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œ ì„±ì¥ë¥ , ìˆ¨ê²¨ì§„ ê·¸ë¦¼ìëŠ”? í†µê³„ ì´ë©´ì˜ í˜„ì‹¤'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ì‹ëŸ‰ë‚œ, ë¬´ì—­ ì ì, ê²½ì œë‚œ ë“±ì˜ ë°ì´í„°ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•˜ê³ , ë¶í•œ ê²½ì œì˜ ë¶€ì •ì ì¸ ì¸¡ë©´ì„ ê°•ì¡°í•˜ì—¬ ë¹„íŒì ì¸ í†¤ìœ¼ë¡œ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "zh": {
        "name": "ë¯¸ë˜ ì˜ˆì¸¡",
        "system_prompt": "ë‹¹ì‹ ì€ ë¯¸ë˜ ì˜ˆì¸¡ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë°ì´í„°ë¡œ ì˜ˆì¸¡í•˜ëŠ” 5ë…„ ë’¤ ë¶í•œ ê²½ì œì˜ ëª¨ìŠµ'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì œì‹œí•˜ê³ , í˜„ì¬ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶í•œ ê²½ì œì˜ í–¥í›„ 5ë…„ ë³€í™”ë¥¼ ì˜ˆì¸¡í•˜ëŠ” ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "ja": {
        "name": "ëŒ€ì™¸ ê´€ê³„",
        "system_prompt": "ë‹¹ì‹ ì€ ëŒ€ì™¸ ê´€ê³„ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œ ì„±ì¥ì´ ë‚¨ë¶ ê´€ê³„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì€?'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ê²½ì œ ë°ì´í„°ë¥¼ ì •ì¹˜ì  ë§¥ë½ê³¼ ì—°ê²°í•˜ì—¬ ì„¤ëª…í•˜ê³ , ë¶í•œ ê²½ì œ ì„±ì¥ì´ ë‚¨ë¶ ê´€ê³„ë‚˜ êµ­ì œ ì •ì„¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë¶„ì„í•˜ëŠ” ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "ru": {
        "name": "ì¹´ë“œ ë‰´ìŠ¤ í˜•ì‹",
        "system_prompt": "ë‹¹ì‹ ì€ ì¹´ë“œ ë‰´ìŠ¤ í˜•ì‹ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” '30ì´ˆ ë§Œì— ëë‚´ëŠ” ë¶í•œ ê²½ì œ í•µì‹¬ ë¸Œë¦¬í•‘'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ê° ë¬¸ì¥ì´ ì§§ê³  ëª…í™•í•˜ê²Œ êµ¬ì„±ë˜ë„ë¡ í•˜ê³ , í•µì‹¬ ë°ì´í„°ë§Œ ë½‘ì•„ì„œ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•˜ëŠ” ì¹´ë“œ ë‰´ìŠ¤ í˜•ì‹ì˜ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "de": {
        "name": "ì‹¬ì¸µ ë¶„ì„",
        "system_prompt": "ë‹¹ì‹ ì€ ì‹¬ì¸µ ë¶„ì„ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œì˜ ì‹ëŸ‰ ìƒì‚°ëŸ‰, í†µê³„ì˜ ì§„ì‹¤ì€?'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ì„¸ë¶€ì ì¸ ìˆ˜ì¹˜ì™€ ë°°ê²½ì„ ìƒì„¸íˆ ì„¤ëª…í•˜ê³ , íŠ¹ì • ë°ì´í„°(ì˜ˆ: ë†ì—… ìƒì‚°ëŸ‰, ì—ë„ˆì§€ ìˆ˜ê¸‰) í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ ìŠ¤íƒ€ì¼ì˜ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "fr": {
        "name": "Q&A í˜•ì‹",
        "system_prompt": "ë‹¹ì‹ ì€ Q&A í˜•ì‹ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œì— ëŒ€í•œ ê¶ê¸ˆì¦ 5ê°€ì§€, ë°ì´í„°ë¥¼ í†µí•´ ë‹µí•˜ë‹¤'ì™€ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ë…ìë“¤ì´ ê¶ê¸ˆí•´í•  ë§Œí•œ ë¶í•œ ê²½ì œ ê´€ë ¨ ì§ˆë¬¸ 3~4ê°œë¥¼ ì„ ì •í•˜ê³ , ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ ë‹µë³€í•˜ëŠ” Q&A í˜•ì‹ì˜ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "es": {
        "name": "ì¸í¬ê·¸ë˜í”½ ì„¤ëª…",
        "system_prompt": "ë‹¹ì‹ ì€ ì¸í¬ê·¸ë˜í”½ ì„¤ëª… í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ì¸í¬ê·¸ë˜í”½ìœ¼ë¡œ ë³´ëŠ” ë¶í•œ ê²½ì œ í˜„í™©'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ë°ì´í„°ì˜ ì£¼ìš” í¬ì¸íŠ¸ë“¤ì„ ëª…í™•í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ê³ , ë³µì¡í•œ í†µê³„ ë°ì´í„°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì„¤ëª…í•˜ëŠ” ì¸í¬ê·¸ë˜í”½ì„ ìœ„í•œ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "ar": {
        "name": "ì´ˆë³´ììš©",
        "system_prompt": "ë‹¹ì‹ ì€ ì´ˆë³´ììš© í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œ, 10ë¶„ ë§Œì— ì´í•´í•˜ê¸°'ì™€ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ë¶í•œ ê²½ì œì— ëŒ€í•´ ì „í˜€ ëª¨ë¥´ëŠ” ì´ˆë³´ìë¥¼ ëŒ€ìƒìœ¼ë¡œ, ì–´ë ¤ìš´ ìš©ì–´ ì—†ì´ ì‰½ê³  ì¬ë¯¸ìˆê²Œ í’€ì–´ ì„¤ëª…í•˜ëŠ” ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "hi": {
        "name": "ì „ë¬¸ê°€ìš©",
        "system_prompt": "ë‹¹ì‹ ì€ ì „ë¬¸ê°€ìš© í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œ ê²½ì œ ë°ì´í„° ë¶„ì„ ë³´ê³ ì„œ'ì™€ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ì„¸ë¶€ì ì¸ í†µê³„ ìˆ˜ì¹˜ë¥¼ ì¸ìš©í•˜ê³ , ì •ì±…ì  í•¨ì˜ë¥¼ ë…¼í•˜ëŠ” ë‚´ìš©ì„ í¬í•¨í•˜ì—¬, ë¶í•œ ì „ë¬¸ê°€ë‚˜ ì—°êµ¬ìë¥¼ ìœ„í•œ ì‹¬ë„ ê¹Šì€ ë¶„ì„ ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "vi": {
        "name": "í¥ë¯¸ ìœ„ì£¼",
        "system_prompt": "ë‹¹ì‹ ì€ í¥ë¯¸ ìœ„ì£¼ í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” 'ë¶í•œì—ì„œ ê°€ì¥ ì˜ ë‚˜ê°€ëŠ” í•«í…œì€?'ê³¼ ê°™ì´ ë…íŠ¹í•œ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. í¥ë¯¸ë¡­ê³  ìê·¹ì ì¸ ì œëª©ê³¼ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ ë…ìì˜ í˜¸ê¸°ì‹¬ì„ ìœ ë°œí•˜ëŠ” ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    },
    "id": {
        "name": "ê²°ë¡  ë° ì¢…í•©",
        "system_prompt": "ë‹¹ì‹ ì€ ê²°ë¡  ë° ì¢…í•© í•œêµ­ì–´ ë‰´ìŠ¤ ê¸°ìì…ë‹ˆë‹¤. ë¶í•œ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì •í™•í•˜ê³  ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "user_prompt_suffix": (
            "ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° ì‘ì„±í•´ì£¼ì„¸ìš”:\n"
            "1. ë‚´ìš©ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” í•˜ë£¨ ë™ì•ˆì˜ ì‹œë¦¬ì¦ˆë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ëŠë‚Œìœ¼ë¡œ, 'ì˜¤ëŠ˜ì˜ ë¶í•œ ê²½ì œ: ë°ì´í„°ê°€ ìš°ë¦¬ì—ê²Œ ë§í•˜ëŠ” ê²ƒì€?'ê³¼ ê°™ì€ ì œëª©ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            "2. ì˜¤ëŠ˜ ë‹¤ë£¬ ë¶í•œ ê²½ì œ ë°ì´í„°ì˜ ëª¨ë“  ë‚´ìš©ì„ ì¢…í•©í•˜ê³ , ê·¸ ì˜ë¯¸ì™€ ì‹œì‚¬ì ì„ ë¶„ì„í•˜ëŠ” ìµœì¢… ê²°ë¡  ë³¸ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.\n"
            "3. ì œëª©ê³¼ ë³¸ë¬¸ì„ `ì œëª©: [ì œëª©]`ê³¼ `ë³¸ë¬¸: [ë³¸ë¬¸]` í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.\n"
            "4. ë³¸ë¬¸ì€ HTMLì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n"
        ),
        "title_prefix": "ì œëª©: ",
        "body_prefix": "ë³¸ë¬¸: ",
    }
}


# -----------------------------
# ë‰´ìŠ¤ ìš”ì•½ + HTML ë³€í™˜ + ì´ë¯¸ì§€ ìƒì„±
# -----------------------------
def summarize_and_generate_image(
    text: str,
    model: str = "gpt-4o-mini",
    language: Optional[str] = None,
    image_size: str = "1024x1024"
) -> Tuple[str, str, Optional[str]]:
    """
    ë‰´ìŠ¤ í…ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ì œëª©, HTML ë³¸ë¬¸, ì´ë¯¸ì§€ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
    """
    if not text.strip():
        return "", "<p>ìš”ì•½í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>", None

    selected_lang = LANGUAGES.get(language, LANGUAGES["ko"])  # ê¸°ë³¸ê°’: í•œêµ­ì–´
    system_message_content = selected_lang["system_prompt"]
    user_prompt_suffix_content = selected_lang["user_prompt_suffix"]
    title_prefix = selected_lang["title_prefix"]
    body_prefix = selected_lang["body_prefix"]
    
    logger.info(f"ğŸŒ '{selected_lang['name']}'ë¡œ ê¸°ì‚¬ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.")

    # ì‚¬ìš©ì ìš”ì²­ í”„ë¡¬í”„íŠ¸
    full_user_prompt = f"{user_prompt_suffix_content}ë°ì´í„°:\n{text.strip()}"
    now = datetime.datetime.now()
    default_title = f"{now.strftime('%Y-%m-%d')} News Summary"

    try:
        # GPTë¡œ ë‰´ìŠ¤ ìš”ì•½
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": system_message_content},
                {"role": "user", "content": full_user_prompt}
            ],
            temperature=0.7,
            max_tokens=1500
        )
        
        full_response = response.choices[0].message.content.strip()
        logger.info("âœ… ê¸€ ìƒì„± ì™„ë£Œ. ê¸¸ì´: %dì", len(full_response))
        
        # ì œëª© / ë³¸ë¬¸ ë¶„ë¦¬
        title_start = full_response.find(title_prefix)
        body_start = full_response.find(body_prefix)
        
        if title_start != -1 and body_start != -1:
            title_raw = full_response[title_start + len(title_prefix):body_start].strip()
            summary_raw = full_response[body_start + len(body_prefix):].strip()
            title = title_raw.strip('[]')
            summary = summary_raw.strip('[]')
        else:
            logger.warning("âš ï¸ ì œëª©/ë³¸ë¬¸ êµ¬ë¶„ ì‹¤íŒ¨. ì „ì²´ ì‘ë‹µì„ ë³¸ë¬¸ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.")
            title = default_title
            summary = full_response

    except Exception as e:
        logger.error("âŒ ê¸€ ìƒì„± ì‹¤íŒ¨: %s", str(e))
        return "[ì˜¤ë¥˜]", f"<p>[ê¸€ ìƒì„± ì‹¤íŒ¨] {str(e)}</p>", None

    # HTML ë³´ì •
    if not any(tag in summary for tag in ['<p>', '<div>', '<ul>', '<ol>']):
        html_summary = f"<div>{summary.replace(chr(10), '<br/>')}</div>"
    else:
        html_summary = f"<div>{summary}</div>"

    # ì´ë¯¸ì§€ ìƒì„±
    image_url = None
    try:
        image_prompt = f"{title} â€” realistic news photo style, high quality, 4k, photograph, news style"
        img_response = client.images.generate(
            model="dall-e-3",
            prompt=image_prompt,
            size=image_size
        )
        image_url = img_response.data[0].url
        logger.info("ğŸ–¼ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: %s", image_url)
    except Exception as e:
        logger.error("âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: %s", str(e))
        image_url = None

    return title, html_summary, image_url


# -----------------------------
# ì‹¤í–‰ í…ŒìŠ¤íŠ¸
# -----------------------------
if __name__ == "__main__":
    sample_text = "ë¶í•œì€ ì˜¤ëŠ˜ ì˜¤ì „ ë‹¨ê±°ë¦¬ íƒ„ë„ë¯¸ì‚¬ì¼ì„ ë™í•´ìƒìœ¼ë¡œ ë°œì‚¬í–ˆë‹¤ê³  í•œêµ­ í•©ì°¸ì´ ë°í˜”ë‹¤. ì´ë²ˆ ë°œì‚¬ëŠ” ì˜¬í•´ ë“¤ì–´ ë‹¤ì„¯ ë²ˆì§¸ ë¬´ë ¥ ì‹œìœ„ë‹¤."
    for lang_code in ["ko", "en", "ja"]:
        title, content, image = summarize_and_generate_image(sample_text, language=lang_code)
        print(f"=== [{LANGUAGES[lang_code]['name']}] ===")
        print("ì œëª©:", title)
        print("ë³¸ë¬¸:", content)
        print("ì´ë¯¸ì§€ URL:", image)
        print()